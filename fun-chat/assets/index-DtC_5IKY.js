(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();class ${children=[];_subscriptions=[];get node(){return this._element}addClasses(e){e&&e.length>0&&this._element.classList.add(...e)}removeClasses(e){e&&e.length>0&&this._element.classList.remove(...e)}toggleClass(e){e&&this._element.classList.toggle(e)}setAttributes(e){if(e)for(const[t,s]of Object.entries(e))s&&this._element.setAttribute(t,s)}getAttribute(e){return this._element.getAttribute(e)}removeAttribute(e){this._element.removeAttribute(e)}appendChildren(...e){for(const t of e)t instanceof $?(this._element.append(t.node),this.children=[...this.children,t]):t instanceof Node&&this._element.append(t)}deleteChildren(){for(this.children.map(e=>{e.deleteElement()}),this.children=[];this._element.firstChild;)this._element.firstChild.remove()}deleteElement(){this.deleteChildren(),this.unsubscribeAll(),this._element.remove()}sub(...e){e.forEach(t=>{this._subscriptions.push(t)})}unsubscribeAll(){this._subscriptions.forEach(e=>{e()})}addListener(e,t){this._element.addEventListener(e,t)}removeListener(e,t){this._element.removeEventListener(e,t)}dispatchEvent(e,t){const s=new CustomEvent(e,{detail:t});this._element.dispatchEvent(s)}}class a extends ${_element;constructor(e){super(),this._element=document.createElement(e.tag),e&&(this.addClasses(e.classNames),this.setText(e.text),this.setAttributes(e.attributes))}setText(e){e&&(this._element.textContent=e)}}class P extends ${_element;constructor(e){super(),this._element=document.createElementNS("http://www.w3.org/2000/svg","svg"),e.classNames&&this.addClasses(e.classNames),this.setAttributes(e.attributes);const t=document.createElementNS("http://www.w3.org/2000/svg","use");t.setAttribute("href",e.href),this.appendChildren(t)}}const K="_footer_1by5p_1",z={footer:K};class X extends a{constructor(){super({tag:"footer",classNames:[z.footer]}),this.render()}render(){const e=new a({tag:"a",attributes:{href:"https://rs.school/"}}),t=new P({href:"./rss.svg#rss",attributes:{width:"100",height:"36",fill:"black"}});e.appendChildren(t);const s=new a({tag:"a",attributes:{href:"https://github.com/YaroshenkoAnna"}}),n=new P({href:"./sprite.svg#git",attributes:{width:"36",height:"36",fill:"black"}});s.appendChildren(n);const r=new a({tag:"p",text:"2025 Â© Anna Yaroshenko"});this.appendChildren(e,r,s)}}const Z="_overlay_1yp9u_1",Q="_spinner_1yp9u_14",R={overlay:Z,spinner:Q};class ee extends a{constructor(){super({tag:"div",classNames:[R.overlay]}),this.render()}render(){const e=new a({tag:"div",classNames:[R.spinner]}),t=new a({tag:"p",classNames:[R.text],text:"Connecting..."});this.appendChildren(e,t)}}const te="_button_1vaki_1",se={button:te};class m extends a{constructor(e){super({tag:"button",classNames:[...e.classNames??[],se.button],text:e.text,attributes:e.attributes}),this.addListener("click",e.callback)}disable(){this.setAttributes({disabled:"true"})}enable(){this.removeAttribute("disabled")}setDisabled(e){e?this.disable():this.enable()}}class ne{listeners=new Set;emit(e){for(const t of this.listeners)t(e)}subscribe(e){return this.listeners.add(e),this.unsubscribe.bind(this,e)}unsubscribe(e){this.listeners.delete(e)}}class p extends ne{constructor(e){super(),this._value=e}get value(){return this._value}set(e){this._value=e,this.emit(this._value)}update(e){this._value=e(this._value),this.emit(this._value)}subscribeAndGet(e){return e(this._value),this.subscribe(e)}}const ie="_error_173rj_1",V={error:ie,"error-message":"_error-message_173rj_8"};class T extends a{value$=new p("");errorMessage=new a({tag:"label",classNames:[V["error-message"]]});constructor(e){super({tag:"input",classNames:e.classNames,text:e.text,attributes:e.attributes}),this.setType(e.type),this.addListener("input",()=>{this.value$.set(this.value)})}get value(){return this._element.value}set value(e){this._element.value=e,this.value$.set(e)}disable(){this._element.setAttribute("disabled","true")}enable(){this._element.removeAttribute("disabled")}setType(e){this._element.setAttribute("type",e)}observe(e){return this.value$.subscribeAndGet(e)}showErrors(e){this.errorMessage.deleteElement(),this._element.classList.toggle(V.error,e.length>0),e.length>0&&(this._element.parentElement?.appendChild(this.errorMessage.node),this.errorMessage.setText(e.join(`
`)))}}const re="_main_112px_1",ae="_form_112px_13",oe="_fieldset_112px_20",le="_label_112px_33",ce="_input_112px_26",f={main:re,form:ae,fieldset:oe,"input-container":"_input-container_112px_26",label:le,input:ce};class de{routes;outlet;defaultRoute;errorRoute;constructor(e,t,s,n){this.routes=e,this.outlet=t,this.defaultRoute=s,this.errorRoute=n,globalThis.addEventListener("hashchange",()=>{this.loadRoute()}),globalThis.location.hash===""?this.navigate(this.defaultRoute):this.loadRoute()}async loadRoute(){const t=globalThis.location.hash.replace(/^#\/?/,"/"),s=this.routes.find(n=>n.path===t)||this.routes.find(n=>n.path===this.errorRoute);if(s){const n=await s.page(this);this.outlet.node.replaceChildren(n.node)}else console.error(`Route for path ${t} not found.`)}navigate(e,t=!1){const s=`#/${e.replace(/^\/+/,"")}`;if(t&&globalThis.location.hash!==s){const n=new URL(globalThis.location.href);n.hash=s,globalThis.location.replace(n.toString())}else globalThis.location.hash=s}}let x=null;function M(){if(!x)throw new Error("Router has not been initialized yet.");return x}function he(o,e,t,s){return x=new de(o,e,t,s),x}class B extends a{formVM;loginVM;form=new a({tag:"form",classNames:[f.form]});fieldset=new a({tag:"fieldset",classNames:[f.fieldset]});legend=new a({tag:"legend",text:"Authorization"});loginContainer=new a({tag:"div",classNames:[f["input-container"]]});loginLabel=new a({tag:"label",classNames:[f.label],text:"Login"});passwordLabel=new a({tag:"label",classNames:[f.label],text:"Password"});passwordContainer=new a({tag:"div",classNames:[f["input-container"]]});loginInput=new T({type:"text",classNames:[f.input],attributes:{id:"name",placeholder:"Enter your name"}});passwordInput=new T({type:"password",classNames:[f.input],attributes:{id:"password",placeholder:"Enter password"}});submitButton=new m({text:"Submit",attributes:{type:"submit"},callback:e=>{e.preventDefault(),this.onSubmit()}});infoButton=new m({text:"Info",callback:()=>{M().navigate("/info")}});constructor(e,t){super({tag:"main",classNames:[f.main]}),this.formVM=t,this.loginVM=e,this.render(),this.bind()}render(){this.appendChildren(this.form),this.form.appendChildren(this.fieldset,this.submitButton,this.infoButton),this.fieldset.appendChildren(this.legend,this.loginContainer,this.passwordContainer),this.loginContainer.appendChildren(this.loginLabel,this.loginInput),this.passwordContainer.appendChildren(this.passwordLabel,this.passwordInput)}bind(){this.formVM.isFormValid$.subscribe(e=>{this.submitButton.setDisabled?.(!e)}),this.loginInput.observe(e=>{this.formVM.setLogin(e),this.loginInput.showErrors(this.formVM.getLoginErrors())}),this.passwordInput.observe(e=>{this.formVM.setPassword(e),this.passwordInput.showErrors(this.formVM.getPasswordErrors())})}async onSubmit(){await this.loginVM.submit(this.loginInput.value,this.passwordInput.value)}}const ue="_main_br4ga_1",ge="_header_br4ga_10",me="_contacts_br4ga_21",pe="_dialog_br4ga_22",fe="_content_br4ga_33",ve="_list_br4ga_79",be="_title_br4ga_96",h={main:ue,header:ge,contacts:me,dialog:pe,content:fe,"dialog-input":"_dialog-input_br4ga_48","message-input":"_message-input_br4ga_55","dialog-header":"_dialog-header_br4ga_60","dialog-body":"_dialog-body_br4ga_69",list:ve,"buttons-container":"_buttons-container_br4ga_85","current-user":"_current-user_br4ga_92",title:be},_e="_contact_asv6y_1",we="_login_asv6y_7",Ce="_container_asv6y_11",Ee="_status_asv6y_17",Ue="_message_asv6y_23",C={contact:_e,login:we,container:Ce,status:Ee,message:Ue};var L=(o=>(o.Online="Online",o.Offline="Offline",o))(L||{}),H=(o=>(o.Online="green",o.Offline="red",o))(H||{});class D extends a{constructor(e,t,s,n){super({tag:"li",classNames:[C.contact]}),this.render(e,t,s,n)}render(e,t,s,n){const r=new a({tag:"label",classNames:[C.login],text:e}),i=new a({tag:"div",classNames:[C.container]}),l=new a({tag:"span",classNames:[C.status],attributes:{style:`background-color: ${H[t]}`}}),c=new a({tag:"span",classNames:[C.message],text:s>0?String(s):""});this.appendChildren(i,c),i.appendChildren(l,r),i.addListener("click",()=>{n()})}}class Le{messages={};unreadCounts={};currentUserLogin="";setCurrentUserLogin(e){this.currentUserLogin=e}getMessages$(e){return this.messages[e]||(this.messages[e]=new p([])),this.messages[e]}setMessages(e,t){this.getMessages$(e).set(t),t.some(n=>n.to===this.currentUserLogin)&&this.updateUnreadCount(e)}addMessage(e,t){const s=this.getMessages$(e).value;this.getMessages$(e).set([...s,t]),t.to===this.currentUserLogin&&this.updateUnreadCount(t.from)}updateStatus(e,t){for(const s in this.messages){const n=this.messages[s].value,r=n.findIndex(i=>i.id===e);if(r!==-1){const i=[...n];i[r]={...i[r],status:{...i[r].status,...t}},this.messages[s].set(i),this.updateUnreadCount(s);return}}}updateText(e,t,s){for(const n in this.messages){const r=this.messages[n].value,i=r.findIndex(l=>l.id===e);if(i!==-1){const l=[...r];l[i]={...l[i],text:t,status:{...l[i].status,...s}},this.messages[n].set(l),this.updateUnreadCount(n);return}}}getUnreadCount$(e){return this.unreadCounts[e]||(this.unreadCounts[e]=new p(0)),this.unreadCounts[e]}updateUnreadCount(e){const s=this.getMessages$(e).value.filter(n=>!n.status.isReaded&&n.from===e&&n.to===this.currentUserLogin).length;this.getUnreadCount$(e).set(s)}removeMessage(e){console.log("removeMessage",e);for(const t in this.messages){const s=this.messages[t].value,n=s.findIndex(r=>r.id===e);if(n!==-1){const r=s.slice();r.splice(n,1),this.messages[t].set(r),this.updateUnreadCount(t);return}}}}const g=new Le,ye="_list_1tqyc_1",xe="_divider_1tqyc_10",G={list:ye,divider:xe},Se="_message_ojohq_1",$e="_own_ojohq_10",Me="_text_ojohq_15",Ne="_info_ojohq_21",Re="_status_ojohq_28",Ie="_controls_ojohq_36",Ae="_button_ojohq_42",Te="_foreign_ojohq_59",u={message:Se,own:$e,text:Me,info:Ne,status:Re,controls:Ie,button:Ae,foreign:Te};let y=null;function Oe(o){y&&y!==o&&y.deactivate(),y=o}class ke extends a{modal=null;controls;isControlsVisible=!1;constructor(e,t,s,n){super({tag:"li",classNames:[u.message]});const r=new Date(e.datetime).toLocaleTimeString(),i=e.from===t;this.addClasses(i?[u.own]:[u.foreign]);const l=new a({tag:"div",classNames:[u.text],text:e.text}),c=new a({tag:"div",classNames:[u.info],text:`${e.from} â¢ ${r}${e.status.isEdited?" â¢ edited":""}`}),_=new a({tag:"span",classNames:[u.status],text:i?e.status.isReaded?"ââ":e.status.isDelivered?"â":"":""});if(this.controls=new a({tag:"div",classNames:[u.controls]}),i){const w=new m({text:"âï¸",classNames:[u.button],callback:()=>{s?.(e.id,e.text),this.hideControls()}}),N=new m({text:"ğï¸",classNames:[u.button],callback:()=>{this.showConfirm(()=>n?.(e.id)),this.hideControls()}});this.controls.appendChildren(w,N)}this.addListener("click",w=>{w.stopPropagation(),Oe(this),this.toggleControls()}),document.addEventListener("click",()=>this.hideControls()),this.appendChildren(c,_,l)}deactivate(){this.hideControls(),this.modal?.deleteElement()}toggleControls(){this.isControlsVisible?this.hideControls():this.showControls()}showControls(){this.isControlsVisible||(this.appendChildren(this.controls),this.isControlsVisible=!0)}hideControls(){this.isControlsVisible&&(this.controls.deleteElement(),this.modal?.deleteElement(),this.isControlsVisible=!1)}showConfirm(e){this.modal&&this.modal.deleteElement(),this.modal=new a({tag:"div",classNames:[u.confirmModal]});const t=new a({tag:"p",text:"Delete this message?"}),s=new m({text:"Delete",classNames:[u.confirmButton],callback:()=>{e(),this.modal?.deleteElement()}}),n=new m({text:"Cancel",classNames:[u.cancelButton],callback:()=>{this.modal?.deleteElement()}});this.modal.appendChildren(t,s,n),this.appendChildren(this.modal)}}class Pe extends a{constructor(e,t,s=null,n,r){super({tag:"ul",classNames:[G.list]}),this.render(e,t,s,n,r)}render(e,t,s,n,r){if(!e.length){this.appendChildren(new a({tag:"div",text:"This is the beginning of your conversation."}));return}e.forEach((i,l)=>{s!==null&&l===s&&this.appendChildren(new a({tag:"hr",classNames:[G.divider]})),this.appendChildren(new ke(i,t,n,r))}),setTimeout(()=>{this.node.scrollTop=this.node.scrollHeight},0)}}class q extends a{header=new a({tag:"section",classNames:[h.header]});content=new a({tag:"section",classNames:[h.content]});contacts=new a({tag:"aside",classNames:[h.contacts]});dialog=new a({tag:"section",classNames:[h.dialog]});currentUser=new a({tag:"label",classNames:[h["current-user"]]});title=new a({tag:"h1",classNames:[h.title],text:"Fun Chat"});buttonsContainer=new a({tag:"div",classNames:[h["buttons-container"]]});infoButton=new m({text:"Info",classNames:[h.button],callback:()=>{M().navigate("/info")}});logoutButton;search=new T({type:"text",classNames:[h.search],attributes:{placeholder:"Search"}});usersList=new a({tag:"ul",classNames:[h.list]});dialogHeader=new a({tag:"div",classNames:[h["dialog-header"]]});dialogBody=new a({tag:"div",classNames:[h["dialog-body"]]});dialogInput=new a({tag:"form",classNames:[h["dialog-input"]]});selectedUser=new a({tag:"label",text:"Selected user"});status=new a({tag:"label",text:"Status"});info=new a({tag:"label",classNames:[h.info],text:"Write your first message"});messageInput=new a({tag:"textarea",classNames:[h["message-input"]],attributes:{placeholder:"Type your message"}});sendButton=new m({text:"Send",attributes:{type:"submit"},callback:e=>{e.preventDefault(),this.sendMessage()}});selectedLogin=null;userStore;messageService;currentUserLogin;unreadSubscriptions={};editingMessageId=null;constructor(e,t,s){super({tag:"main",classNames:[h.main]}),this.logoutButton=new m({text:"Logout",classNames:[h.button],callback:()=>{t.logout()}}),this.userStore=e;const n=this.userStore.currentUser$?.value;n?.login&&g.setCurrentUserLogin(n.login),this.userStore.activeUsers$.subscribe(r=>{const i=this.userStore.inactiveUsers$.value;this.renderContacts(r,i)}),this.userStore.inactiveUsers$.subscribe(r=>{const i=this.userStore.activeUsers$.value;this.renderContacts(i,r)}),this.currentUser.setText(`User: ${this.userStore?.currentUser$?.value?.login}`),this.messageService=s,this.currentUserLogin=n?.login??"",this.renderContacts(this.userStore.activeUsers$.value,this.userStore.inactiveUsers$.value),this.render()}render(){this.appendChildren(this.header,this.content),this.content.appendChildren(this.contacts,this.dialog),this.header.appendChildren(this.currentUser,this.title,this.buttonsContainer),this.buttonsContainer.appendChildren(this.infoButton,this.logoutButton),this.contacts.appendChildren(this.search,this.usersList),this.dialog.appendChildren(this.dialogHeader,this.dialogBody,this.dialogInput),this.dialogHeader.appendChildren(this.selectedUser,this.status),this.dialogBody.appendChildren(this.info),this.dialogInput.appendChildren(this.messageInput,this.sendButton),this.messageInput.addListener("keydown",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this.sendMessage())}),this.search.addListener("input",e=>{const t=e.target.value;this.userStore.filter(t)})}renderContacts(e,t){for(const i of Object.values(this.unreadSubscriptions))i();this.unreadSubscriptions={},this.usersList.deleteChildren();const s=(i,l)=>{const c=g.getUnreadCount$(i.login);let _=new D(i.login,l,c.value,()=>this.selectUser(i,l));this.usersList.appendChildren(_);const w=c.subscribe(N=>{const O=new D(i.login,l,N,()=>this.selectUser(i,l)),k=Array.from(this.usersList.node.children).indexOf(_.node);k!==-1?(this.usersList.node.children[k].replaceWith(O.node),_=O):console.warn(`[replaceWith] Contact node not found for ${i.login}`)});this.unreadSubscriptions[i.login]=w};e.forEach(i=>s(i,L.Online)),t.forEach(i=>s(i,L.Offline));const r=[...e,...t].find(i=>i.login===this.selectedLogin);if(r){const i=e.includes(r)?L.Online:L.Offline;this.status.setText(`Status: ${i}`)}}selectedMessagesSubscription=null;selectUser(e,t){this.selectedLogin=e.login,this.selectedUser.setText(`Selected: ${e.login}`),this.status.setText(`Status: ${t}`),this.selectedMessagesSubscription&&this.selectedMessagesSubscription();const s=g.getMessages$(e.login);this.selectedMessagesSubscription=s.subscribe(n=>{this.updateMessages(n)}),s.value.length===0?this.messageService.fetchHistory(e.login):this.updateMessages(s.value)}updateMessages(e){this.dialogBody.deleteChildren();const t=e.findIndex(n=>n.to===this.currentUserLogin&&!n.status.isReaded),s=new Pe(e,this.currentUserLogin,t>=0?t:null,this.editMessage.bind(this),this.deleteMessage.bind(this));t>=0&&e.slice(t).forEach(r=>{!r.status.isReaded&&r.to===this.currentUserLogin&&this.messageService.markAsRead(r.id)}),this.dialogBody.appendChildren(s)}sendMessage(){const e=this.messageInput.node.value;if(!this.selectedLogin||!e)return;if(this.editingMessageId){this.messageService.editMessage(this.editingMessageId,e).then(()=>{this.editingMessageId=null,this.sendButton.setText("Send"),this.messageInput.node.value=""});return}const t={id:`temp-${Date.now()}`,from:this.currentUserLogin,to:this.selectedLogin,text:e,datetime:Date.now(),status:{isDelivered:!1,isReaded:!1,isEdited:!1,isDeleted:!1}};g.addMessage(this.selectedLogin,t),this.messageService.send(this.selectedLogin,e).then(()=>{this.messageInput.node.value=""})}editMessage(e,t){this.messageInput.setText(""),this.editingMessageId=e,this.messageInput.node.value=t,this.sendButton.setText("Edit")}deleteMessage(e){this.messageService.deleteMessage(e).then(()=>{g.removeMessage(e)})}}const Ve="_main_f4n5n_1",Be="_title_f4n5n_12",E={main:Ve,title:Be};class De extends a{defaultRoute;constructor(e){super({tag:"main",classNames:[E.main]}),this.defaultRoute=e,this.render()}render(){const e=new a({tag:"h1",classNames:[E.title],text:"Fun Chat"}),t=new a({tag:"p",classNames:[E.paragraph],text:"Fun Chat is a chat application that allows you to communicate with your friends and family in real-time."}),s=new a({tag:"a",classNames:[E.link],text:"Author Anna Yaroshenko",attributes:{href:"https://github.com/YaroshenkoAnna"}}),n=new m({text:"Return",classNames:[E.button],callback:()=>{M().navigate(this.defaultRoute)}});this.appendChildren(e,t,s,n)}}const Ge="_image_5475x_1",qe={image:Ge};class Fe extends a{constructor(){super({tag:"main"}),this.render()}render(){const e=new a({tag:"img",classNames:[qe.image],attributes:{src:"./error.png",alt:"error image"}});this.appendChildren(e)}}const je="ws://localhost:4000";class He{constructor(e=je){this.url=e,this.connect()}socket=null;isConnected$=new p(!1);messageListeners=new Map;connect(){this.socket=new WebSocket(this.url),this.socket.addEventListener("open",()=>{this.isConnected$.set(!0)}),this.socket.addEventListener("close",()=>{this.isConnected$.set(!1),setTimeout(()=>this.connect(),5e3)}),this.socket.addEventListener("error",e=>{console.error("WebSocket error:",e)}),this.socket.addEventListener("message",e=>{const t=JSON.parse(e.data);this.messageListeners.get(t.type)?.forEach(s=>s(t))})}send(e){this.socket?.send(JSON.stringify(e))}on(e,t){return this.messageListeners.has(e)||this.messageListeners.set(e,[]),this.messageListeners.get(e).push(t),()=>{const s=this.messageListeners.get(e);this.messageListeners.set(e,s.filter(n=>n!==t))}}}function v(){return self.crypto.randomUUID()}class Ye{constructor(e){this.client=e}login(e,t){return new Promise((s,n)=>{const r=v(),i=this.client.on("USER_LOGIN",c=>{c.id===r&&(i(),s(c.payload.user))}),l=this.client.on("ERROR",c=>{c.id===r&&(l(),n(c.payload.error))});this.client.send({id:r,type:"USER_LOGIN",payload:{user:{login:e,password:t}}})})}logout(e,t){return new Promise((s,n)=>{const r=v(),i=this.client.on("USER_LOGOUT",c=>{c.id===r&&(i(),s(c.payload.user))}),l=this.client.on("ERROR",c=>{c.id===r&&(l(),n(c.payload.error))});this.client.send({id:r,type:"USER_LOGOUT",payload:{user:{login:e,password:t}}})})}}class We{passwordErrors=[];loginErrors=[];validateForm(e,t){return this.validateLogin(e)&&this.validatePassword(t)}validatePassword(e){this.passwordErrors=[];const t=6,s=20,n=/[A-Z]/.test(e),r=/[a-z]/.test(e),i=/\d/.test(e),l=[{condition:e.length<t,message:`Password must be at least ${t} characters.`},{condition:e.length>s,message:`Password must be no more than ${s} characters.`},{condition:!r||!n||!i,message:"Password must contain at least one uppercase, one lowercase letter  and one number."}];for(const c of l)c.condition&&this.passwordErrors.push(c.message);return this.passwordErrors.length===0}validateLogin(e){this.loginErrors=[];const t=4,s=15;return e.length<t&&this.loginErrors.push(`Login must be at least ${t} characters.`),e.length>s&&this.loginErrors.push(`Login must be no more than ${s} characters.`),this.loginErrors.length===0}}class Je{login$=new p("");password$=new p("");isFormValid$=new p(!1);validator=new We;constructor(){this.login$.subscribe(()=>this.validate()),this.password$.subscribe(()=>this.validate())}setLogin(e){this.login$.set(e)}setPassword(e){this.password$.set(e)}getLoginErrors(){return this.validator.validateLogin(this.login$.value),this.validator.loginErrors}getPasswordErrors(){return this.validator.validatePassword(this.password$.value),this.validator.passwordErrors}validate(){const e=this.validator.validateForm(this.login$.value,this.password$.value);this.isFormValid$.set(e)}}class Ke{constructor(e){this.storage=e}get(e){const t=this.storage.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return null}}set(e,t){this.storage.setItem(e,JSON.stringify(t))}remove(e){this.storage.removeItem(e)}}const I="user",A="userPass";class ze{password=null;currentUser$=new p(null);activeUsers$=new p([]);inactiveUsers$=new p([]);allActiveUsers=[];allInactiveUsers=[];storage;constructor(e){this.storage=e;const t=this.storage.get(I);this.password=this.storage.get(A)??null,t?.isLogined&&this.currentUser$.set(t)}setUser(e,t){this.currentUser$.set(e),this.storage.set(I,e),this.storage.set(A,t),this.password=this.storage.get(A)}clear(){this.currentUser$.set(null),this.storage.remove(I)}get isAuthenticated(){return!!this.currentUser$.value?.isLogined}setActive(e){this.allActiveUsers=e,this.activeUsers$.set(this.excludeCurrentUser(e))}setInactive(e){this.allInactiveUsers=e,this.inactiveUsers$.set(this.excludeCurrentUser(e))}clearAll(){this.activeUsers$.set([]),this.inactiveUsers$.set([])}filter(e){this.activeUsers$.set(this.excludeCurrentUser(this.allActiveUsers)),this.inactiveUsers$.set(this.excludeCurrentUser(this.allInactiveUsers));const t=this.excludeCurrentUser(this.allActiveUsers.filter(n=>n.login.toLowerCase().includes(e.toLowerCase()))),s=this.excludeCurrentUser(this.allInactiveUsers.filter(n=>n.login.toLowerCase().includes(e.toLowerCase())));this.activeUsers$.set(t),this.inactiveUsers$.set(s)}excludeCurrentUser(e){const t=this.currentUser$.value;return t?e.filter(s=>s.login!==t.login):e}}const Xe=new Ke(sessionStorage),d=new ze(Xe);class Ze{constructor(e){this.authService=e}router=null;async submit(e,t){try{const s=await this.authService.login(e,t);return s.isLogined&&this.router?(d.setUser(s,t),this.router.navigate("/main"),null):"Error"}catch(s){return typeof s=="string"?s:"Server error"}}setRouter(e){this.router=e}logout(){const e=d.currentUser$.value;e&&d.password&&this.authService.logout(e.login,d.password).then(()=>{d.clear(),M().navigate("/login")}).catch(console.error)}}const Y="/login",Qe="/error",et="_container_i7vp2_17",tt={container:et};class st{constructor(e){this.client=e,this.subscribeToExternalChanges(),this.fetchAll()}async fetchAll(){const[e,t]=await Promise.all([this.fetchUsers("USER_ACTIVE"),this.fetchUsers("USER_INACTIVE")]);d.setActive(e),d.setInactive(t)}fetchActiveUsers(){return this.fetchUsers("USER_ACTIVE")}fetchInactiveUsers(){return this.fetchUsers("USER_INACTIVE")}fetchUsers(e){return new Promise((t,s)=>{const n=v(),r=this.client.on(e,l=>{l.id===n&&(r(),t(l.payload.users))}),i=this.client.on("ERROR",l=>{l.id===n&&(i(),s(l.payload.error))});this.client.send({id:n,type:e,payload:null})})}subscribeToExternalChanges(){this.client.on("USER_EXTERNAL_LOGIN",e=>{const t=e.payload.user;if(t.isLogined){const s=d.activeUsers$.value,n=d.inactiveUsers$.value;s.some(l=>l.login===t.login)||d.setActive([...s,t]);const i=n.filter(l=>l.login!==t.login);i.length!==n.length&&d.setInactive(i)}}),this.client.on("USER_EXTERNAL_LOGOUT",e=>{const t=e.payload.user,s=d.activeUsers$.value.filter(i=>i.login!==t.login);d.setActive(s);const n=d.inactiveUsers$.value;n.some(i=>i.login===t.login)||d.setInactive([...n,t])})}}class nt{constructor(e){this.client=e,this.subscribeToMessages()}send(e,t){const s=v();return this.sendRequest("MSG_SEND",{message:{to:e,text:t}},s)}fetchHistory(e){const t=v();return this.sendRequest("MSG_FROM_USER",{user:{login:e}},t).then(s=>(g.setMessages(e,s.messages),s.messages))}markAsRead(e){const t=v();return this.sendRequest("MSG_READ",{message:{id:e}},t).then(()=>{})}deleteMessage(e){const t=v();return this.sendRequest("MSG_DELETE",{message:{id:e}},t).then(()=>{})}editMessage(e,t){const s=v();return this.sendRequest("MSG_EDIT",{message:{id:e,text:t}},s).then(()=>{})}subscribeToMessages(){this.client.on("MSG_SEND",e=>{const t=e.payload.message;g.addMessage(t.from,t)}),this.client.on("MSG_DELIVER",e=>{g.updateStatus(e.payload.message.id,{isDelivered:!0})}),this.client.on("MSG_READ",e=>{g.updateStatus(e.payload.message.id,{isReaded:!0})}),this.client.on("MSG_DELETE",e=>{g.updateStatus(e.payload.message.id,{isDeleted:!0})}),this.client.on("MSG_EDIT",e=>{const{id:t,text:s,status:n}=e.payload.message;g.updateText(t,s,n)})}sendRequest(e,t,s){return new Promise((n,r)=>{const i=this.client.on(e,c=>{c.id===s&&(i(),n(c.payload))}),l=this.client.on("ERROR",c=>{c.id===s&&(l(),r(c.payload.error))});this.client.send({id:s,type:e,payload:t})})}}const W=new a({tag:"div",classNames:[tt.container]});document.body.append(W.node,new X().node);const S=new He,J=new Ye(S),F=new Je,U=new Ze(J),j=new nt(S),it=[{path:"/login",page:async o=>d.isAuthenticated?(o.navigate("/main",!0),new q(d,U,j)):(U.setRouter(o),new B(U,F))},{path:"/main",page:async o=>d.isAuthenticated?await new q(d,U,j):(o.navigate("/login",!0),new B(U,F))},{path:"/info",page:()=>Promise.resolve(new De(Y))},{path:"/error",page:()=>Promise.resolve(new Fe)}];he(it,W,Y,Qe);let b=null;S.isConnected$.subscribeAndGet(o=>{!o&&!b?(b=new ee,document.body.append(b.node)):o&&b&&(b.deleteElement(),b=null,new st(S),d.isAuthenticated&&d.password&&J.login(d.currentUser$.value.login,d.password).catch(console.error))});
