(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();class f{children=[];_subscriptions=[];get node(){return this._element}addClasses(t){t&&t.length>0&&this._element.classList.add(...t)}removeClasses(t){t&&t.length>0&&this._element.classList.remove(...t)}toggleClass(t){t&&this._element.classList.toggle(t)}setAttributes(t){if(t)for(const[e,s]of Object.entries(t))s&&this._element.setAttribute(e,s)}getAttribute(t){return this._element.getAttribute(t)}removeAttribute(t){this._element.removeAttribute(t)}appendChildren(...t){for(const e of t)e instanceof f?(this._element.append(e.node),this.children=[...this.children,e]):e instanceof Node&&this._element.append(e)}deleteChildren(){for(this.children.map(t=>{t.deleteElement()}),this.children=[];this._element.firstChild;)this._element.firstChild.remove()}deleteElement(){this.deleteChildren(),this.unsubscribeAll(),this._element.remove()}sub(...t){t.forEach(e=>{this._subscriptions.push(e)})}unsubscribeAll(){this._subscriptions.forEach(t=>{t()})}addListener(t,e,s=!1){this._element.addEventListener(t,e,s)}removeListener(t,e,s=!1){this._element.removeEventListener(t,e,s)}dispatchEvent(t,e){const s=new CustomEvent(t,{detail:e});this._element.dispatchEvent(s)}}class a extends f{_element;constructor(t){super(),this._element=document.createElement(t.tag),t&&(this.addClasses(t.classNames),this.setText(t.text),this.setAttributes(t.attributes))}setText(t){t&&(this._element.textContent=t)}}const N="_button_izud5_1",W={button:N};class c extends a{constructor(t){super({tag:"button",classNames:[...t.classNames??[],W.button],text:t.text}),this.addListener("click",t.callback)}disable(){this.setAttributes({disabled:"true"})}enable(){this.removeAttribute("disabled")}setDisabled(t){t?this.disable():this.enable()}}const F="_navigation_1ssdn_1",k={navigation:F};class M extends a{garageButton;winnersButton;constructor(){super({tag:"nav",classNames:[k.navigation]}),this.garageButton=new c({text:"Garage",callback:()=>{globalThis.location.hash="/garage"}}),this.winnersButton=new c({text:"Winners",callback:()=>{globalThis.location.hash="/winners"}}),this.garageButton.setAttributes({disabled:"true"}),this.appendChildren(this.garageButton,this.winnersButton),globalThis.addEventListener("hashchange",()=>this.updateButtonState()),this.updateButtonState()}updateButtonState(){const t=globalThis.location.hash;t==="#/garage"?(this.garageButton.setAttributes({disabled:"true"}),this.winnersButton.removeAttribute("disabled")):t==="#/winners"&&(this.winnersButton.setAttributes({disabled:"true"}),this.garageButton.removeAttribute("disabled"))}}class p extends a{constructor(t){super({tag:"input"}),this.setType(t.type)}get value(){return this._element.value}set value(t){this._element.value=t}disable(){this._element.setAttribute("disabled","true")}enable(){this._element.removeAttribute("disabled")}setType(t){this._element.setAttribute("type",t)}}const U="_form_s3fuo_1",I="_button_s3fuo_36",B={form:U,button:I};class P extends a{textInput;colorInput;options;constructor(t){super({tag:"form",classNames:[B.form]}),this.options=t,this.textInput=new p({type:"text"}),this.colorInput=new p({type:"color"}),this.render()}disable(){this.children.forEach(t=>{(t instanceof c||t instanceof p)&&t.disable()})}enable(){this.children.forEach(t=>{(t instanceof c||t instanceof p)&&t.enable()})}clear(){this.textInput.value="",this.colorInput.value="#000000"}render(){const t=new c({text:this.options.buttonText,classNames:[B.button],callback:e=>{e.preventDefault(),this.options.callback(this.textInput.value,this.colorInput.value).catch(s=>{console.error("Error in callback:",s)})}});this.appendChildren(this.textInput,this.colorInput,t)}}class E extends f{_element;constructor(t){super(),this._element=document.createElementNS("http://www.w3.org/2000/svg","svg"),t.classNames&&this.addClasses(t.classNames),this.setAttributes(t.attributes);const e=document.createElementNS("http://www.w3.org/2000/svg","use");e.setAttribute("href",t.href),this.appendChildren(e)}}const O="_card_1cxco_1",H="_select_1cxco_18",K="_title_1cxco_42",j="_start_1cxco_52",D="_reset_1cxco_65",G="_car_1cxco_1",X="_flag_1cxco_82",u={card:O,select:H,delete:"_delete_1cxco_30",title:K,start:j,reset:D,car:G,flag:X};class C extends a{car;id;buttons;startButton;backButton;name;color;carImage;constructor(t,e,s){super({tag:"div",classNames:[u.card]}),this.id=t,this.name=e,this.color=s,this.car=new a({tag:"div",classNames:[u.car]}),this.carImage=new E({href:"./sprite.svg#auto",attributes:{width:"100",height:"50"}}),this.buttons=[],this.startButton=new c({classNames:[u.start],text:"A",callback:()=>{const n=new CustomEvent("carMoveStarted",{detail:{id:this.id},bubbles:!0});this.backButton.enable(),this.startButton.disable(),this.node.dispatchEvent(n)}}),this.backButton=new c({classNames:[u.reset],text:"B",callback:()=>{const n=new CustomEvent("carMoveReset",{detail:{id:this.id},bubbles:!0});this.startButton.enable(),this.backButton.disable(),this.node.dispatchEvent(n)}}),this.backButton.disable(),this.render()}changeCarColor(t){this.carImage.node.setAttribute("fill",t)}render(){const t=new a({tag:"h3",text:this.name,classNames:[u.title]});this.changeCarColor(this.color);const e=new c({text:"Select",classNames:[u.select],callback:()=>{const r=new CustomEvent("carSelected",{detail:{id:this.id,name:this.name,color:this.color},bubbles:!0});this.node.dispatchEvent(r)}});this.car.appendChildren(this.carImage);const s=new c({text:"Remove",classNames:[u.delete],callback:()=>{const r=new CustomEvent("carRemoved",{detail:{id:this.id},bubbles:!0});this.node.dispatchEvent(r)}}),n=new E({classNames:[u.flag],href:"./sprite.svg#flag",attributes:{width:"40",height:"40"}});this.buttons.push(e,s,this.startButton,this.backButton),this.appendChildren(e,s,t,this.startButton,this.backButton,this.car,n)}}class v{static BASE_URL="http://localhost:3000/engine";static async startEngine(t){const e=await fetch(`${this.BASE_URL}?id=${t}&status=started`,{method:"PATCH"});if(!e.ok)throw new Error("Failed to start engine");return e.json()}static async stopEngine(t){if(!(await fetch(`${this.BASE_URL}?id=${t}&status=stopped`,{method:"PATCH"})).ok)throw new Error("Failed to stop engine")}static async drive(t){const e=await fetch(`${this.BASE_URL}?id=${t}&status=drive`,{method:"PATCH"});if(!e.ok)throw e.status===500?new Error("Engine failure"):new Error("Failed to drive");return e.json()}}class w{static animationFrameIds=new Map;static isAnimating=new Map;static isEngineRunning=new Map;static stopAnimation(t){this.isAnimating.set(t,!1),this.animationFrameIds.has(t)&&(cancelAnimationFrame(this.animationFrameIds.get(t)),this.animationFrameIds.delete(t))}static resetCarPosition(t,e){this.isAnimating.set(t,!1),this.isEngineRunning.set(t,!1),e.style.transform="translateX(0px)"}static async moveCar(t,e){const s=await v.startEngine(t.id);if(typeof s!="object"||s===null||!("distance"in s)||!("velocity"in s)||typeof s.distance!="number"||typeof s.velocity!="number")throw new Error("Invalid response from engine service");const n=e/s.velocity;return this.isAnimating.set(t.id,!0),this.isEngineRunning.set(t.id,!0),await Promise.all([this.animateCar(t.id,t.element,n,e),this.monitorDriveStatus(t.id)]),n}static async startRace(t){const e=t.map(({id:n,element:r})=>{const o=r.parentElement.clientWidth-r.offsetWidth;return this.moveCar({id:n,element:r},o).then(l=>({id:n,time:l})).catch(()=>null)});return await Promise.race(e)}static resetAll(t){t.forEach(({id:e,element:s})=>{this.resetCarPosition(e,s)})}static async monitorDriveStatus(t){try{try{await v.drive(t)}catch(e){for(;this.isAnimating.get(t);){if(e instanceof Error&&e.message==="Engine failure"){this.stopAnimation(t),await v.stopEngine(t);break}if(e instanceof Error&&e.message.includes("Failed to drive"))break}await new Promise(s=>setTimeout(s,500))}}catch(e){console.error(` Unexpected error for car ${t}:`,e)}}static async animateCar(t,e,s,n){const r=performance.now();return new Promise(o=>{const l=S=>{if(!this.isAnimating.get(t))return;const R=(S-r)/1e3,x=Math.min(R/s,1);if(e.style.transform=`translateX(${x*n}px)`,x<1){const T=requestAnimationFrame(l);this.animationFrameIds.set(t,T)}else this.isAnimating.set(t,!1),this.isEngineRunning.set(t,!1),o()},d=requestAnimationFrame(l);this.animationFrameIds.set(t,d)})}}function V(i){return typeof i=="object"&&i!==null&&"id"in i&&typeof i.id=="number"&&"name"in i&&typeof i.name=="string"&&"color"in i&&typeof i.color=="string"}function _(i){return typeof i=="object"&&i!==null&&"id"in i&&typeof i.id=="number"}const J="_modal_1atks_1",q={modal:J};class z extends a{constructor(t,e){super({tag:"div"}),this.addClasses([q.modal]),this.setText(`${t} is the winner! Time: ${e.toFixed(2)}s`),globalThis.addEventListener("click",s=>{s.target!==this.node&&this.deleteElement()})}}class h{static BASE_URL="http://localhost:3000";static getCar(t){return fetch(`${this.BASE_URL}/garage/${t}`).then(e=>e.ok?e.json():null)}static async getCars(t,e=7){const s=await fetch(`${this.BASE_URL}/garage?_page=${t}&_limit=${e}`);if(!s.ok)throw new Error("Failed to fetch cars");const n=await s.json(),r=Number(s.headers.get("X-Total-Count"))||0;return{cars:n,total:r}}static async createCar(t,e){await fetch(`${this.BASE_URL}/garage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,color:e})})}static async deleteCar(t){await fetch(`${this.BASE_URL}/garage/${t}`,{method:"DELETE"})}static async updateCar(t){await fetch(`${this.BASE_URL}/garage/${t.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t.name,color:t.color})})}static async getWinners(t,e=10,s,n){const r=new URLSearchParams({_page:String(t),_limit:String(e)});s&&r.set("_sort",s),n&&r.set("_order",n);const o=await fetch(`${this.BASE_URL}/winners?${r.toString()}`);if(!o.ok)throw new Error("Failed to fetch winners");const l=await o.json(),d=Math.max(Number(o.headers.get("X-Total-Count"))||0,l.length);return{items:l,total:d}}static async getWinner(t){const e=await fetch(`${this.BASE_URL}/winners/${t}`);return e.ok?e.json():null}static async createWinner(t){await fetch(`${this.BASE_URL}/winners`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}static async updateWinner(t,e){await fetch(`${this.BASE_URL}/winners/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}static async deleteWinner(t){await fetch(`${this.BASE_URL}/winners/${t}`,{method:"DELETE"})}static async getAllWinners(t,e){const s=new URLSearchParams;t&&s.set("_sort",t),e&&s.set("_order",e);const n=await fetch(`${this.BASE_URL}/winners?${s.toString()}`);if(!n.ok)throw new Error("Failed to fetch all winners");return await n.json()}}const Q="_controls_7wzm8_1",Y={controls:Q};class Z extends a{raceButton;resetButton;generateButton;constructor(t){super({tag:"div",classNames:[Y.controls]}),this.raceButton=new c({text:"Race",callback:t.onRace}),this.resetButton=new c({text:"Reset",callback:t.onReset}),this.resetButton.disable(),this.generateButton=new c({text:"Generate cars",callback:t.onGenerate}),this.appendChildren(this.raceButton,this.resetButton,this.generateButton)}disable(){this.raceButton.disable(),this.generateButton.disable(),this.resetButton.disable()}enable(){this.raceButton.enable(),this.generateButton.enable(),this.resetButton.enable()}setResetEnabled(t){t?this.resetButton.enable():this.resetButton.disable()}}const tt="_container_fnb45_1",et="_title_fnb45_10",st="_pagination_fnb45_35",nt="_button_fnb45_42",m={container:tt,title:et,"page-number":"_page-number_fnb45_15","car-list":"_car-list_fnb45_28",pagination:st,button:nt};class rt extends a{selectedCarId=null;outlet;title;pageNumber;store;carListContainer;createForm;updateForm;controls;activeCars=new Set;pagination;constructor(t,e){super({tag:"div",classNames:[m.container]}),this.store=t,this.outlet=e,this.title=new a({tag:"h1",text:"Garage (0)",classNames:[m.title]}),this.pageNumber=new a({tag:"h2",text:"Page #1",classNames:[m["page-number"]]}),this.carListContainer=new a({tag:"div",classNames:[m["car-list"]]}),this.store.total$.subscribe(s=>{this.title.setText(`Garage (${s})`)}),this.controls=new Z({onRace:()=>{this.startRace()},onReset:()=>this.resetAll(),onGenerate:()=>{this.store.generateRandomCars()}}),this.createForm=this.renderCreateForm(),this.updateForm=this.renderUpdateForm(),this.pagination=this.renderPagination(),this.render(),this.bindStore()}handleSelectCar(t){this.selectedCarId=t,this.controls.disable()}render(){this.updateForm.disable(),this.appendChildren(this.createForm,this.updateForm,this.controls,this.title,this.pageNumber,this.carListContainer,this.pagination)}renderCreateForm(){return new P({buttonText:"Create",callback:async(t,e)=>{try{await this.store.addCar(t,e)}catch(s){console.error("Error while adding car:",s)}}})}renderUpdateForm(){return new P({buttonText:"Update",callback:async(t,e)=>{if(this.selectedCarId===null){console.error("No car selected!");return}try{await this.store.updateCar({id:this.selectedCarId,name:t,color:e}),this.updateForm.clear(),this.updateForm.disable(),this.createForm.enable(),this.selectedCarId=null,this.controls.enable()}catch(s){console.error("Error while updating car:",s)}}})}async startRace(){this.resetAll(),this.pagination.children.forEach(e=>{e instanceof c&&e.disable()}),this.updateForm.disable(),this.createForm.disable(),this.controls.disable(),this.controls.setResetEnabled(!0);const t=[];for(const e of this.carListContainer.children)e instanceof C&&e.car.node instanceof HTMLElement&&(e.buttons.forEach(s=>s.disable()),t.push({id:e.id,element:e.car.node}));try{const e=await w.startRace(t);if(e){const s=await h.getCar(e.id);s&&(await this.store.addWinner(e.id,e.time),this.outlet.appendChildren(new z(s.name,e.time)))}}catch(e){console.error("Race error:",e)}}resetAll(){this.controls.enable(),this.createForm.enable(),this.pagination.children.forEach(e=>{e instanceof c&&e.enable()}),this.controls.setResetEnabled(!0);const t=[];for(const e of this.carListContainer.children)e instanceof C&&e.car.node instanceof HTMLElement&&(e.buttons.forEach(s=>{s!==e.backButton&&s.enable()}),t.push({id:e.id,element:e.car.node}));w.resetAll(t),this.activeCars.clear(),this.controls.setResetEnabled(!1)}renderPagination(){const t=new a({tag:"div",classNames:[m.pagination]}),e=new c({text:"Prev",classNames:[m.button],callback:()=>{this.store.previous("garage").catch(n=>{console.error("Error going to the previous page:",n)})}}),s=new c({text:"Next",classNames:[m.button],callback:()=>{this.store.next("garage").catch(n=>{console.error("Error going to the next page:",n)})}});return this.store.total$.subscribe(()=>{const n=this.store.getCurrentPage("garage"),r=this.store.total$.value,o=Math.ceil(r/this.store.pageLimits.garage);n===1?e.disable():e.enable(),n===o?s.disable():s.enable()}),t.appendChildren(e,s),t}bindStore(){this.store.cars$.subscribe(t=>this.renderCarList(t)),this.store.total$.subscribe(t=>{const e=this.store.getCurrentPage("garage"),s=Math.ceil(t/this.store.pageLimits.garage);e>s&&this.store.previous("garage").catch(l=>{console.error("Error going to the previous page:",l)});const n=(e-1)*this.store.pageLimits.garage+1,r=Math.min(e*this.store.pageLimits.garage,t),o=n===r?n:`${n}-${r}`;this.pageNumber.setText(`Page #${this.store.getCurrentPage("garage")} / cars: ${o}`)}),this.store.loadCars(this.store.getCurrentPage("garage")).catch(t=>{console.error("Error loading cars:",t)})}renderCarList(t){this.carListContainer.deleteChildren(),t.forEach(e=>{const s=new C(e.id,e.name,e.color);s.addListener("carSelected",n=>{n instanceof CustomEvent&&V(n.detail)&&(this.updateForm.textInput.value=n.detail.name,this.updateForm.colorInput.value=n.detail.color,this.createForm.disable(),this.updateForm.enable(),this.handleSelectCar(n.detail.id))}),s.addListener("carRemoved",n=>{(async()=>{if(n instanceof CustomEvent&&_(n.detail)){const r=n.detail.id;try{await this.store.removeCar(r)}catch(o){console.error("Error while removing car:",o)}}})()}),s.addListener("carMoveStarted",n=>{(async()=>{if(n instanceof CustomEvent&&_(n.detail)){const r=n.detail.id;this.activeCars.add(r),this.controls.setResetEnabled(!0);try{const o=s.car.node;o instanceof HTMLElement?await w.moveCar({id:r,element:o},this.outlet.node.clientWidth-o.offsetWidth):console.error("Car element is not a valid HTMLElement.")}catch(o){console.error("Error while starting car:",o)}}})()}),s.addListener("carMoveReset",n=>{(()=>{if(n instanceof CustomEvent&&_(n.detail)){const r=n.detail.id;s.car.node instanceof HTMLElement&&w.resetCarPosition(r,s.car.node),this.activeCars.delete(r),this.activeCars.size===0&&this.controls.setResetEnabled(!1)}})()}),this.carListContainer.appendChildren(s)})}}const at="_title_1w1te_6",it="_table_1w1te_16",ot="_sortable_1w1te_37",ct="_controls_1w1te_41",lt="_button_1w1te_45",g={"winners-page":"_winners-page_1w1te_1",title:at,"page-number":"_page-number_1w1te_11",table:it,sortable:ot,controls:ct,button:lt,"car-svg":"_car-svg_1w1te_66"};class ht extends a{constructor(t){super({tag:"div"}),this.store=t,this.render(),this.store.winnersCount$.subscribe(()=>{this.title.setText(`Winners (${this.store.winnersCount$.value})`),this.updateButtons(),this.updatePageNumber()}),this.ensureValidPage(),this.loadCurrentWinners(),this.store.winners$.subscribe(e=>{this.ensureValidPage(),this.renderWinners(e)})}title=new a({tag:"h1",text:"Winners (0)",classNames:[g.title]});pageNumber=new a({tag:"h2",text:"Page #1",classNames:[g["page-number"]]});tableBody=new a({tag:"tbody"});headerWins=new a({tag:"th",classNames:[g.sortable]});headerBestTime=new a({tag:"th",classNames:[g.sortable]});sortAllWinners=!0;sortKey="time";sortOrder="asc";previousButton=new c({text:"Prev",callback:()=>void this.store.previous("winners")});nextButton=new c({text:"Next",callback:()=>void this.store.next("winners")});async ensureValidPage(){const t=this.store.pageLimits.winners,e=this.store.winnersCount$.value,s=Math.max(1,Math.ceil(e/t));this.store.getCurrentPage("winners")>s&&await this.store.loadWinners(s,this.store.pageLimits.winners,this.sortKey,this.sortOrder.toUpperCase(),this.sortKey==="wins"&&this.sortAllWinners)}async loadCurrentWinners(){const t=this.store.getCurrentPage("winners"),e=this.store.pageLimits.winners;await this.store.loadWinners(t,e,this.sortKey,this.sortOrder.toUpperCase(),this.sortKey==="wins"&&this.sortAllWinners)}updateButtons(){const t=this.store.getCurrentPage("winners"),e=this.store.pageLimits.winners,s=this.store.winnersCount$.value,n=Math.ceil(s/e);this.previousButton.setDisabled(t===1),this.nextButton.setDisabled(t>=n)}updatePageNumber(){const t=this.store.getCurrentPage("winners");this.pageNumber.setText(`Page #${t}`)}render(){const t=new a({tag:"table",classNames:[g.table]}),e=new a({tag:"thead"}),s=new a({tag:"tr"}),n=new a({tag:"th",text:"№"}),r=new a({tag:"th",text:"ID"}),o=new a({tag:"th",text:"Car"}),l=new a({tag:"th",text:"Name"});this.headerWins.node.style.cursor="pointer",this.headerWins.addListener("click",()=>void this.toggleSort("wins")),this.headerBestTime.node.style.cursor="pointer",this.headerBestTime.addListener("click",()=>void this.toggleSort("time")),s.appendChildren(n,r,o,l,this.headerWins,this.headerBestTime),e.appendChildren(s),t.appendChildren(e,this.tableBody),this.appendChildren(this.title,this.pageNumber,t),this.updateHeaders(),this.renderControls()}async toggleSort(t){this.sortKey===t?this.sortOrder=this.sortOrder==="desc"?"asc":"desc":(this.sortKey=t,this.sortOrder="desc"),this.store.winnersSortKey=this.sortKey,this.store.winnersSortOrder=this.sortOrder.toUpperCase(),this.store.sortAllWinners=this.sortKey==="wins"&&this.sortAllWinners,this.updateHeaders(),await this.loadCurrentWinners()}async renderWinners(t){this.tableBody.deleteChildren();let e=(this.store.getCurrentPage("winners")-1)*this.store.pageLimits.winners+1;for(const s of t){const n=new a({tag:"tr"});n.appendChildren(new a({tag:"td",text:(e++).toString()}),new a({tag:"td",text:`${s.id}`}));try{const r=await h.getCar(s.id),o=new a({tag:"td"}),l=new E({href:"./sprite.svg#auto",classNames:[g["car-svg"]],attributes:{width:"40",height:"40",fill:r?.color||"#000000"}});o.appendChildren(l),n.appendChildren(o,new a({tag:"td",text:r?.name||"Unknown"}),new a({tag:"td",text:`${s.wins}`}),new a({tag:"td",text:`${s.time.toFixed(2)}`}))}catch(r){console.error(`Error loading car ${s.id}`,r)}this.tableBody.appendChildren(n)}}getHeaderText(t,e){return this.sortKey===t?`${e} ${this.sortOrder==="asc"?"↑":"↓"}`:e}updateHeaders(){this.headerWins.setText(this.getHeaderText("wins","Wins")),this.headerBestTime.setText(this.getHeaderText("time","Best Time (seconds)"))}renderControls(){this.appendChildren(this.previousButton,this.nextButton),this.previousButton.addClasses([g.button]),this.nextButton.addClasses([g.button]),this.updateButtons()}}class dt{listeners=new Set;emit(t){for(const e of this.listeners)e(t)}subscribe(t){return this.listeners.add(t),this.unsubscribe.bind(this,t)}unsubscribe(t){this.listeners.delete(t)}}class b extends dt{constructor(t){super(),this._value=t}get value(){return this._value}set(t){this._value=t,this.emit(this._value)}update(t){this._value=t(this._value),this.emit(this._value)}silentUpdate(t){this._value=t(this._value)}}const ut=16777215,gt=()=>`#${Math.floor(Math.random()*ut).toString(16)}`,$=i=>i[Math.floor(Math.random()*i.length)];class mt{cars$=new b([]);total$=new b(0);winners$=new b([]);winnersCount$=new b(0);winnersSortKey="time";winnersSortOrder="ASC";sortAllWinners=!1;pageLimits={garage:7,winners:10};currentPage={garage:1,winners:1};pageLoaders={garage:this.loadCars.bind(this),winners:this.loadWinners.bind(this)};async next(t){const e=this.currentPage[t]+1;this.currentPage[t]=e,await this.pageLoaders[t](e,this.pageLimits[t])}async previous(t){const e=Math.max(1,this.currentPage[t]-1);this.currentPage[t]=e,await this.pageLoaders[t](e,this.pageLimits[t])}getCurrentPage(t){return this.currentPage[t]}async addCar(t,e){try{await h.createCar(t,e),await this.loadCars(this.currentPage.garage)}catch(s){this.handleError(s,"Failed to add car")}}async removeCar(t){try{await h.deleteCar(t),await h.deleteWinner(t),await this.loadCars(this.currentPage.garage),await this.reloadCurrentWinnersPage()}catch(e){this.handleError(e,"Error deleting car")}}async updateCar(t){try{await h.updateCar(t),await this.loadCars(this.currentPage.garage);const e=await h.getWinner(t.id);e&&(await h.updateWinner(t.id,{wins:e.wins,time:e.time}),await this.reloadCurrentWinnersPage())}catch(e){this.handleError(e,"Error updating car")}}async loadWinners(t,e,s=this.winnersSortKey,n=this.winnersSortOrder,r=this.sortAllWinners){this.winnersSortKey=s,this.winnersSortOrder=n,this.sortAllWinners=r;try{let o=[],l;if(r){const d=await h.getAllWinners(s,n);l=d.length,o=d.slice((t-1)*e,t*e)}else{const d=await h.getWinners(t,e,s,n);o=d.items,l=d.total}this.winners$.set([...o]),this.winnersCount$.set(l),this.currentPage.winners=t}catch(o){this.handleError(o,"Error loading winners")}}async loadCars(t){try{const{cars:e,total:s}=await h.getCars(t);this.cars$.set(e),this.total$.set(s),this.currentPage.garage=t}catch(e){this.handleError(e,"Error loading cars")}}async addWinner(t,e){try{const s=await h.getWinner(t);await(s?h.updateWinner(t,{time:Math.min(s.time,e),wins:s.wins+1}):h.createWinner({id:t,wins:1,time:e})),await this.reloadCurrentWinnersPage()}catch(s){this.handleError(s,"Error adding/updating winner")}}async reloadCurrentWinnersPage(){const t=this.getCurrentPage("winners"),e=this.pageLimits.winners;await this.loadWinners(t,e,this.winnersSortKey,this.winnersSortOrder,this.sortAllWinners)}getWinners(){return[...this.winners$.value]}async generateRandomCars(){const t=["Ford","BMW","Audi","Mercedes","Tesla","Toyota","Honda","Nissan","Lexus","Porsche"],e=["X1","X3","X5","A4","A6","C-Class","E-Class","Model S","Model 3","Camry","Civic","Altima","RX","911","Macan"],s=Array.from({length:100},()=>{const n=`${$(t)} ${$(e)}`,r=gt();return h.createCar(n,r)});try{await Promise.all(s),await this.loadCars(this.currentPage.garage)}catch(n){n instanceof Error?console.error("Error generating cars:",n.message):console.error("Unknown error:",n)}}handleError(t,e){t instanceof Error?console.error(`${e}:`,t.message):console.error(`${e}: Unknown error`,t)}}class pt{defaultRoute="/garage";routes;outlet;constructor(t,e){this.routes=t,this.outlet=e,globalThis.addEventListener("hashchange",()=>{this.loadRoute()}),globalThis.location.hash===""?this.navigate(this.defaultRoute):this.loadRoute()}async loadRoute(){const t=globalThis.location.hash.slice(1),e=this.routes.find(s=>s.path===t);if(e){const s=await e.page(this);this.outlet.node.replaceChildren(s.node)}else console.error(`Route for path ${t} not found.`)}navigate(t){globalThis.location.hash=t}}const wt=[{path:"/garage",page:()=>Promise.resolve(ft)},{path:"/winners",page:()=>Promise.resolve(Ct)}];class bt extends a{constructor(){super({tag:"div"});const t=new a({tag:"h1",text:"404"}),e=new a({tag:"p",text:"Page not found"});this.appendChildren(t,e)}}const A=new a({tag:"div"}),y=new a({tag:"div"});document.body.append(A.node);const L=new mt,ft=new rt(L,y),Ct=new ht(L);new bt;const vt=new M;A.appendChildren(vt,y);new pt(wt,y);
